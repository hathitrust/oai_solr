---
version: '3'

services:

  web:
    build: .
    ports:
      - "4567:4567"
    volumes:
      - .:/usr/src/app
      - gem_cache:/gems
    command: bundle exec ruby oai_solr.rb -o 0.0.0.0
    environment:
      SOLR_URL: http://solr-sdr-catalog:9033/solr/catalog
    depends_on:
      - solr-sdr-catalog

  test:
    build: .
    volumes:
      - .:/usr/src/app
      - gem_cache:/gems
    command: bash -c "bin/wait-for solr-sdr-catalog:9033 && bundle exec rspec"
    environment:
      SOLR_URL: http://solr-sdr-catalog:9033/solr/catalog
    depends_on:
      - solr-sdr-catalog

  solr-sdr-catalog:
    image: ghcr.io/hathitrust/catalog-solr-sample
    ports:
      - "9033:9033"

volumes:
  gem_cache:
